# âœ… 23. Async & Await ì‚¬ìš©í•´ë³´ê¸°

#### #Async #Networking #Swift 

## **ğŸ”** ì‘ì„± ëª©ì 

ë„¤íŠ¸ì›Œí‚¹ì€ í•´ë„í•´ë„ í—·ê°ˆë¦´ ë•Œê°€ ì •ë§ ë§ë‹¤.   
í”„ë¡œì íŠ¸ë¥¼ í•˜ë©° ë„¤íŠ¸ì›Œí¬ í†µì‹ ì´ ëë‚œ ì´í›„ ê·¸ ë°ì´í„°ë¥¼ ë°›ì•„ ë˜ ë„¤íŠ¸ì›Œí‚¹ì„ í•˜ëŠ” 2ì¤‘ë„¤íŠ¸ì›Œí‚¹(?)   
ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ë ¤ í•˜ëŠ”ë° ì—¬ëŸ¬ê°€ì§€ ë¬¸ì œì ì— ë¶€ë”ªíˆê¸°ë„ í–ˆë‹¤...   
í•˜ì§€ë§Œ ê°€ì¥ ë§ì´ ë§ˆì£¼ì³ì•¼ í•˜ëŠ” ìŠ¤íƒ ì¤‘ í•˜ë‚˜ì´ê¸° ë•Œë¬¸ì— ì •ë¦¬í•˜ë©° ëŒì•„ë³´ë ¤ í•œë‹¤! 

<br>

## ğŸ“Œ ì ìš© ë°©ë²•

### 1. ê°€ì¥ ê¸°ë³¸ì ì¸ í˜•íƒœì˜ ë„¤íŠ¸ì›Œí‚¹

ê°„ë‹¨í•˜ê²Œ APIë¥¼ í†µí•´ GETí•˜ëŠ” ë„¤íŠ¸ì›Œí‚¹ ë©”ì„œë“œë‹¤.   
parsingëœ `parseData`ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

~~~swift
func performRequest(with url: String) {

    // 1. URL ìƒì„±
    guard let url = URL(string: url) else { return }

    // 2. URLSession ì‹œì‘
    URLSession.shared.dataTask(with: url) { data, response, error in
            
        // ì—ëŸ¬ ì²´í¬
        if error != nil {
            print("ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬")
            return
        }
        
        // response ì²´í¬
        guard let response = response as? HTTPURLResponse else { return }
        print(String(response.statusCode))
            
        // ë°ì´í„° ì²´í¬
        guard let safeData = data else {
            print("ë°ì´í„° ì—ëŸ¬")
            return
        }
        
        // ë°ì´í„° ë³€í™˜
        if let parseData = self.parseJSON(safeData) {
            print("ë°ì´í„° Parsing ì„±ê³µ")
        } else {
            print("ë°ì´í„° Parsing ì‹¤íŒ¨")
            return
        }
    }.resume()
    
}

// JSON Parsing ë©”ì„œë“œ
func parseJSON(_ data: Data) -> MyData? {
    let parseData = try? JSONDecoder().decode(MyData.self, from: data)
    return parseData
}
~~~

<br>

### 2. Result íƒ€ì…ì„ ì´ìš©í•œ ë„¤íŠ¸ì›Œí‚¹

ì¡°ê¸ˆ ë” ì§„í™”(?) í•œ ë²„ì „ìœ¼ë¡œ ì„±ê³µê³¼ ì‹¤íŒ¨ ì¼€ì´ìŠ¤ë¥¼ ëª…í™•íˆ ë‚˜ëˆŒ ìˆ˜ ìˆë‹¤.   
`Result<ì„±ê³µíƒ€ì…, ì‹¤íŒ¨(ì—ëŸ¬)íƒ€ì…>`

~~~swift
// ë„¤íŠ¸ì›Œí‚¹ ì—ëŸ¬ ì—´ê±°í˜•
enum NetworkError: Error {
    case urlError
    case networkingError
    case dataError
    case parseError
}

// Result íƒ€ì…ì„ typealiasë¥¼ ì‚¬ìš©í•´ ê°€ë…ì„±ì„ ë†’ì¸ë‹¤.
typealias NetworkCompletion = (Result<MyData, NetworkError>) -> Void

// ì„±ê³µ ì‹œ MyData íƒ€ì…ì„, ì‹¤íŒ¨ ì‹œ NetworkError íƒ€ì…ì„ ì½œë°±í•¨ìˆ˜ë¡œ ë°˜í™˜í•œë‹¤. (ë°–ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì¨ì•¼í•˜ê¸° ë•Œë¬¸ì— @escaping í•„ìˆ˜)
func performRequest(with url: String, completion: @escaping NetworkCompletion) {
    
    // URL ìƒì„±
    guard let url = URL(string: url) else {
        print("URL ì—ëŸ¬")
        completion(.failure(.urlError))
        return
    }
    
    URLSession(configuration: .default).dataTask(with: url) { data, response, error in
        
        // ì—ëŸ¬ ì²´í¬
        if error != nil {
            print("ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬")
            completion(.failure(.networkingError))
            return
        }
        
        // response ì²´í¬
        guard let response = response as? HTTPURLResponse else { return }
        print(String(response.statusCode))
            
        // ë°ì´í„° ì²´í¬
        guard let safeData = data else {
            print("ë°ì´í„° ì—ëŸ¬")
            completion(.failure(.dataError))
            return
        }
        
        // ë°ì´í„° ë³€í™˜
        if let parseData = self.parseJSON(safeData) {
            print("ë°ì´í„° Parsing ì„±ê³µ")
            completion(.success(parseData))
        } else {
            print("ë°ì´í„° Parsing ì‹¤íŒ¨")
            completion(.failure(.parseError))
            return
        }
    }.resume()
}

// ë©”ì„œë“œ ì‹¤í–‰
networkManager.performRequest(with: url) { result in
    switch result {
        // ì„±ê³µ!
        case .success(let data):
        print(data)

        // ì‹¤íŒ¨...
        case .failure(let error):
        print(error)
    }
}
~~~

<br>

### 3. Async/Await ë„¤íŠ¸ì›Œí‚¹

ê³µë¶€í•˜ë©´ì„œ ì²˜ìŒ ì¨ë³¸ í›„ ë†€ë¼ì›€ ê·¸ ì¡ì±„...   
ìˆœì„œëŒ€ë¡œ ì½”ë“œì˜ íë¦„ì´ ì˜ ë³´ì¼ë¿ë§Œ ì•„ë‹ˆë¼, ì¼ë°˜ì ì¸ ë¹„ë™ê¸° ì‘ì—…ì€ ë¦¬í„´ íƒ€ì…ìœ¼ë¡œ ì„¤ê³„í•˜ë©´ nilì´ ëœ¨ëŠ” ê²ƒ ë•Œë¬¸ì—   
ì½œë°±í•¨ìˆ˜ì˜ ì§€ì˜¥ì— ë¹ ì§€ê³¤ í–ˆëŠ”ë° ì´ê±°ëŠ” ë¦¬í„´ íƒ€ì…ì´ ë„ˆë¬´ë„ˆë¬´ ëª…í™•í•˜ë‹¤!!!   
ì™œ ì§€ê¸ˆì—ì„œì•¼ ì¨ë´¤ë‚˜,, ë¼ëŠ” ìƒê°ì´ ë“¤ì •ë„ë¡œ í¸ë¦¬í•˜ë‹¤.   
í•˜ì§€ë§Œ ì•„ì§ì€ ìµìˆ™ì¹˜ ì•Šìœ¼ë‹ˆ ì ì ˆíˆ ì„ì–´ì„œ ì‚¬ìš©í•´ë³´ë ¤ í•œë‹¤ ã…ã…

~~~swift
// ë¹„ë™ê¸° í•¨ìˆ˜ì´ê¸° ë•Œë¬¸ì— async í‚¤ì›Œë“œë¥¼ ë¶™ì—¬ì¤€ë‹¤!
func asyncRequest(url: URL) async throws -> MyData? {
    
    // ë¹„ë™ê¸° ë¶€ë¶„ì— await í‚¤ì›Œë“œ ì¶”ê°€ 
    /// (ì¼ë°˜ì ì¸ ì½œë°±í•¨ìˆ˜ë¥¼ ì´ìš©í•´ ì„¤ê³„í•  ë•Œì™€ëŠ” ë‹¤ë¥´ê²Œ await í‚¤ì›Œë“œê°€ ë¶™ìœ¼ë©´ ì´ ì‘ì—…ì´ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¸ë‹¤ ë°‘ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•œë‹¤.)
    /// ì—ëŸ¬ ì²˜ë¦¬ìš© try
    let (data, response) = try await URLSession.shared.data(from: url)

    // ë¦¬í„´ì´ ë„ˆë¬´ë‚˜ë„ ëª…í™•í•˜ë‹¤
    return parseJSON(data)
}

// ë©”ì„œë“œ ì‹¤í–‰
Task { // Taskë¼ëŠ” íŠ¹ë³„í•œ í‚¤ì›Œë“œ ì•ˆì— ê°ì‹¼ë‹¤.

    // í•¨ìˆ˜ ì‹¤í–‰!
    guard let data = try? await networkManager.asyncRequest(url: url) else { return }
    print(data)
}
~~~

## ğŸ’Œ Ref.
- [jake-kimë‹˜ì˜ tistoty](https://ios-development.tistory.com/958)

## ğŸª Obsidian Link
- [[49. DispatchQueueì— ì˜ˆì•½ëœ ì‘ì—… ì·¨ì†Œí•˜ê¸°]]